<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Batch Timer GUI</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; }
    header { padding: 12px 16px; background: #0f172a; color: white; }
    main { padding: 16px; }
    .row { display: flex; gap: 24px; align-items: flex-start; }
    .panel { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e2e8f0; padding: 6px 8px; text-align: left; }
    input, select, textarea, button { padding: 8px; font-size: 14px; }
    .actions { display: flex; gap: 8px; }
    .mono { font-family: ui-monospace, Menlo, monospace; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; }
    .error { color: #b91c1c; }
  </style>
</head>
<body>
  <header>
    <h1>Batch Timer GUI</h1>
      <div class="mono">Workspace: . （このフォルダ配下の .plist を対象）</div>
  </header>
  <main>
    <div class="row">
      <div class="panel" style="max-width: 480px;">
        <h2>ジョブ一覧</h2>
        <table id="jobs-table">
          <thead>
              <tr><th>ファイル名</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="jobs-error" class="error"></p>
      </div>
      <div class="panel">
        <h2>詳細 / 編集</h2>
        <div id="detail">
          <p>ジョブを選択してください。</p>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 16px;">
      <h2>新規ジョブ作成</h2>
      <form id="create-form">
        <div class="grid">
          <label>ファイル名（.plist）</label>
          <input name="name" placeholder="com.example.job.plist" required />
          <label>作成場所</label>
          <select name="location">
            <option value="workspace">Workspace (このフォルダ)</option>
            <option value="launchagents">LaunchAgents (~/Library/LaunchAgents)</option>
          </select>
          <label>内容（JSON形式）</label>
          <textarea name="data" rows="8" class="mono" placeholder='{"Label":"com.example.job","ProgramArguments":["/bin/bash","/path/to/script.sh"],"StartCalendarInterval":{"Hour":9,"Minute":0},"RunAtLoad":true}'></textarea>
        </div>
        <div class="actions" style="margin-top: 8px;">
          <button type="submit">作成</button>
        </div>
        <p id="create-error" class="error"></p>
      </form>
    </div>
  </main>

  <script>
    async function fetchJobs() {
      const res = await fetch('/api/jobs');
      if (!res.ok) throw new Error('一覧取得に失敗しました');
      return res.json();
    }

    function renderJobs(jobs) {
      const tbody = document.querySelector('#jobs-table tbody');
      tbody.innerHTML = '';
      for (const j of jobs) {
        const tr = document.createElement('tr');
          tr.innerHTML = `<td>${j.name}</td>`;
        const tdOps = document.createElement('td');
        tdOps.className = 'actions';
        const btnView = document.createElement('button');
        btnView.textContent = '開く';
        btnView.onclick = () => openDetail(j.name);
        const btnDel = document.createElement('button');
        btnDel.textContent = '削除';
        btnDel.onclick = () => deleteJob(j.name);
        tdOps.append(btnView, btnDel);
        const tdOpsWrap = document.createElement('td');
        tdOpsWrap.appendChild(tdOps);
        tr.appendChild(tdOpsWrap);
        tbody.appendChild(tr);
      }
    }

    async function refreshJobs() {
      try {
        const jobs = await fetchJobs();
        console.log(jobs, 12)
        renderJobs(jobs);
        document.getElementById('jobs-error').textContent = '';
      } catch (e) {
        document.getElementById('jobs-error').textContent = e.message;
      }
    }

    async function openDetail(name) {
      const res = await fetch(`/api/jobs/${encodeURIComponent(name)}`);
      if (!res.ok) {
        document.getElementById('detail').innerHTML = '<p class="error">取得に失敗しました</p>';
        return;
      }
      const { path, data } = await res.json();
      const json = JSON.stringify(data, null, 2);
      document.getElementById('detail').innerHTML = `
        <div class="grid">
          <div>ファイル</div><div class="mono">${path}</div>
          <div>内容</div>
          <div>
            <textarea id="edit-json" rows="14" class="mono">${json}</textarea>
          </div>
        </div>
        <div class="actions" style="margin-top:8px;">
          <button id="save-btn">保存</button>
          <button id="load-btn">launchctl load -w</button>
          <button id="unload-btn">launchctl unload</button>
        </div>
        <p id="detail-error" class="error"></p>
      `;
      document.getElementById('save-btn').onclick = async () => {
        try {
          const data = JSON.parse(document.getElementById('edit-json').value);
          const res = await fetch(`/api/jobs/${encodeURIComponent(name)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data })
          });
          if (!res.ok) throw new Error('保存に失敗しました');
          await refreshJobs();
          document.getElementById('detail-error').textContent = '';
        } catch (e) {
          document.getElementById('detail-error').textContent = e.message;
        }
      };
      document.getElementById('load-btn').onclick = async () => {
        const res = await fetch('/api/launchctl/load', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const r = await res.json();
        alert(r.ok ? 'loadしました' : `失敗: ${r.error || r.stderr}`);
      };
      document.getElementById('unload-btn').onclick = async () => {
        const res = await fetch('/api/launchctl/unload', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const r = await res.json();
        alert(r.ok ? 'unloadしました' : `失敗: ${r.error || r.stderr}`);
      };
    }

    async function deleteJob(name) {
      if (!confirm(`${name} を削除しますか？`)) return;
      const res = await fetch(`/api/jobs/${encodeURIComponent(name)}`, { method: 'DELETE' });
      if (!res.ok) {
        alert('削除に失敗しました');
        return;
      }
      await refreshJobs();
    }

    document.getElementById('create-form').onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value.trim();
      let data;
      try { data = JSON.parse(form.data.value || '{}'); }
      catch (e) {
        document.getElementById('create-error').textContent = 'JSONの構文エラー';
        return;
      }
      const res = await fetch('/api/jobs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, data }) });
      if (!res.ok) {
        const r = await res.json().catch(() => ({}));
        document.getElementById('create-error').textContent = r.error || '作成に失敗しました';
        return;
      }
      form.reset();
      document.getElementById('create-error').textContent = '';
      await refreshJobs();
    };

    refreshJobs();
  </script>
</body>
</html>